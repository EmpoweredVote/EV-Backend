version: 1.0
runtime: go1

build:
  commands:
    pre-build:
      - mkdir -p .apprunner
      - curl -fsSL https://go.dev/dl/go1.24.3.linux-amd64.tar.gz -o .apprunner/go.tar.gz
      - tar -C .apprunner -xzf .apprunner/go.tar.gz # creates .apprunner/go/...
      - rm -f .apprunner/go.tar.gz
      - ./.apprunner/go/bin/go version
    build:
      - ./.apprunner/go/bin/go env
      - ./.apprunner/go/bin/go mod download
      - CGO_ENABLED=0 GOOS=linux GOARCH=amd64 ./.apprunner/go/bin/go build -v -o server .

run:
  command: ./server
  network:
    port: 5050
  secrets:
    - name: DATABASE_URL
      value-from: "arn:aws:secretsmanager:us-east-1:361769553908:secret:ev/prod/backend-hKU59w:DATABASE_URL::"
      # value-from: "arn:aws:secretsmanager:us-east-1:361769553908:secret:ev/dev/backend-QwxP7W:DATABASE_URL::"
    - name: ALLOWED_ORIGINS
      value-from: "arn:aws:secretsmanager:us-east-1:361769553908:secret:ev/prod/backend-hKU59w:ALLOWED_ORIGINS::"
      # value-from: "arn:aws:secretsmanager:us-east-1:361769553908:secret:ev/dev/backend-QwxP7W:ALLOWED_ORIGINS::"
    - name: CICERO_KEY
      value-from: "arn:aws:secretsmanager:us-east-1:361769553908:secret:ev/prod/backend-hKU59w:CICERO_KEY::"
      # value-from: "arn:aws:secretsmanager:us-east-1:361769553908:secret:ev/dev/backend-QwxP7W:CICERO_KEY::"
